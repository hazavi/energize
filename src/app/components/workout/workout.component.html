<div class="workout-container">
  <!-- Loading Indicator -->
  @if (isLoading) {
    <app-loading></app-loading>
  }

  <!-- Main Content -->
  @if (!isLoading) {
    <div class="workout-content">
      <header class="workout-header">
        <h2 class="section-title">Weekly Workout Plan</h2>
      </header>
      <!-- Add these scroll indicators inside workout-content div -->
      <div class="scroll-indicator left" id="scroll-left">
        <i class="fas fa-chevron-left"></i>
      </div>
      <div class="scroll-indicator right" id="scroll-right">
        <i class="fas fa-chevron-right"></i>
      </div>
      <!-- Week Calendar View - Now with horizontal scroll -->
      <div class="week-calendar">
        <!-- Day Cards for Each Day of the Week -->
        @for (day of weekDays; track day) {
          <div class="day-card" [id]="'day-' + day"
            [class.rest-day]="isRestDay(day)"
            (click)="openDayZoom(day)">
            <!-- Day Header with Menu and Note -->
            <div class="day-header" [ngClass]="{'today': isToday(day)}">
              <div class="day-header-top">
                <h3 class="day-title">{{ day }}</h3>
                @if (isToday(day)) {
                  <span class="day-date">Today</span>
                }
                <!-- Day menu toggle -->
                <button class="btn btn-icon day-menu-toggle" (click)="toggleDayMenu(day, $event)">
                  <i class="fas fa-ellipsis-vertical"></i>
                </button>
                <!-- Day menu dropdown -->
                @if (dayMenuOpen[day]) {
                  <div class="day-menu-dropdown" (click)="$event.stopPropagation()">
                    @if (!isRestDay(day)) {
                      <button class="menu-item"
                        (click)="startWorkout(day); $event.stopPropagation()">
                        <i class="fas fa-play-circle"></i> Start Workout
                      </button>
                    }
                    <button class="menu-item"
                      (click)="addExerciseToTemplate(getDayTemplate(day)); $event.stopPropagation()">
                      <i class="fas fa-plus"></i> Add Exercise
                    </button>
                    <button class="menu-item" (click)="editDayNote(day); $event.stopPropagation()">
                      <i class="fas fa-pen"></i> Edit Note
                    </button>
                    <button class="menu-item" (click)="toggleRestDay(day); $event.stopPropagation()">
                      <i class="fas fa-bed"></i> {{ isRestDay(day) ? 'Remove Rest Day' : 'Mark as Rest Day' }}
                    </button>
                  </div>
                }
              </div>
              <!-- Day note (if exists) -->
              @if (dayNotes[day]) {
                <div class="day-note">
                  <i class="fas fa-sticky-note"></i>
                  <span>{{ dayNotes[day] }}</span>
                </div>
              }
            </div>
            <!-- Exercises List for this Day -->
            <div class="workout-list">
              @if (getExercisesForDay(day).length) {
                @for (exercise of getExercisesForDay(day); track exercise) {
                  <div class="workout-card"
                    [attr.data-exercise-id]="exercise.id"
                    (click)="openExerciseDetail(exercise); $event.stopPropagation()">
                    <!-- Simplified drag handle with just 2 lines -->
                    <div class="drag-handle">
                      <!-- The lines are created with CSS pseudo-elements -->
                    </div>
                    <div class="workout-info">
                      <!-- Exercise Image/GIF -->
                      <img [src]="getExerciseThumbnail(exercise.exercise_id)"
                        alt="{{ getExerciseName(exercise.exercise_id) }}" class="exercise-img"
                        (error)="handleImageError($event)">
                        <div class="exercise-text">
                          <span class="workout-name">{{ getExerciseName(exercise.exercise_id) }}</span>
                          @if (exercise?.sets?.length) {
                            <span class="set-preview">
                              {{ (exercise.sets?.length ?? 0) }} {{ (exercise.sets?.length ?? 0) === 1 ? 'set'
                              : 'sets' }} •
                              {{ getSetsPreview(exercise) }}
                            </span>
                          }
                        </div>
                      </div>
                      <!-- Exercise Menu -->
                      <div class="menu-container">
                        <button class="btn btn-icon menu-toggle"
                          (click)="toggleWorkoutMenu(exercise.id, $event); $event.stopPropagation()">
                          <i class="fas fa-ellipsis-vertical"></i>
                        </button>
                        @if (menuOpenMap[exercise.id]) {
                          <div class="menu-dropdown"
                            (click)="$event.stopPropagation()">
                            <button class="menu-item" (click)="editTemplateExercise(exercise)">
                              <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="menu-item delete-item"
                              (click)="deleteTemplateExercise(getDayTemplate(day).id, exercise.id)">
                              <i class="fas fa-trash-alt"></i> Delete
                            </button>
                          </div>
                        }
                      </div>
                    </div>
                  }
                } @else {
                  <div class="day-empty-state">
                    <i class="fas fa-dumbbell"></i>
                    <p>No exercises yet</p>
                  </div>
                }
                <!-- Empty State Template -->
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Day Zoom Overlay -->
    @if (zoomedDay) {
      <div class="day-zoom-overlay" (click)="closeDayZoom()">
        <div class="day-zoom-container" (click)="$event.stopPropagation()">
          <div class="day-zoom-header" [ngClass]="{'today': isToday(zoomedDay)}">
            <div class="day-header-content">
              <h2>{{ zoomedDay }} Exercises</h2>
              @if (dayNotes[zoomedDay]) {
                <div class="day-note">
                  <i class="fas fa-sticky-note"></i>
                  <span>{{ dayNotes[zoomedDay] }}</span>
                </div>
              }
            </div>
            <div class="zoom-header-actions">
              <button class="btn btn-primary add-exercise-zoom-btn"
                (click)="addExerciseToTemplate(getDayTemplate(zoomedDay)); $event.stopPropagation()">
                <i class="fas fa-plus"></i> Add Exercise
              </button>
              <button class="close-zoom-btn" (click)="closeDayZoom()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="day-zoom-content">
            <!-- Exercises List for Zoomed Day -->
            <div class="workout-list">
              @for (exercise of getExercisesForDay(zoomedDay); track exercise) {
                <div class="workout-card"
                  (click)="openExerciseDetail(exercise)">
                  <!-- Simplified drag handle with just 2 lines -->
                  <div class="drag-handle">
                    <!-- The lines are created with CSS pseudo-elements -->
                  </div>
                  <div class="workout-info">
                    <!-- Exercise Image/GIF -->
                    <img [src]="getExerciseThumbnail(exercise.exercise_id)"
                      alt="{{ getExerciseName(exercise.exercise_id) }}" class="exercise-img"
                      (error)="handleImageError($event)">
                      <div class="exercise-text">
                        <span class="workout-name">{{ getExerciseName(exercise.exercise_id) }}</span>
                        @if (exercise?.sets?.length) {
                          <span class="set-preview">
                            {{ (exercise.sets?.length ?? 0) }} {{ (exercise.sets?.length ?? 0) === 1 ? 'set' :
                            'sets' }} •
                            {{ getSetsPreview(exercise) }}
                          </span>
                        }
                      </div>
                    </div>
                    <!-- Exercise Menu -->
                    <div class="menu-container">
                      <button class="btn btn-icon menu-toggle"
                        (click)="toggleWorkoutMenu(exercise.id, $event); $event.stopPropagation()">
                        <i class="fas fa-ellipsis-vertical"></i>
                      </button>
                      @if (menuOpenMap[exercise.id]) {
                        <div class="menu-dropdown"
                          (click)="$event.stopPropagation()">
                          <button class="menu-item" (click)="editTemplateExercise(exercise)">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <button class="menu-item delete-item"
                            (click)="deleteTemplateExercise(getDayTemplate(zoomedDay).id, exercise.id)">
                            <i class="fas fa-trash-alt"></i> Delete
                          </button>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Exercise Detail Zoom Overlay -->
      @if (zoomedExercise) {
        <div class="exercise-zoom-overlay" (click)="closeExerciseDetail()">
          <div class="exercise-zoom-container" (click)="$event.stopPropagation()">
            <div class="exercise-zoom-header">
              <h2>{{ getExerciseName(zoomedExercise.exercise_id) }}</h2>
              <button class="close-zoom-btn" (click)="closeExerciseDetail()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <!-- Exercise Image/GIF -->
            <div class="exercise-detail-image-container">
              <img [src]="getExerciseFullImage(zoomedExercise.exercise_id)" alt="Exercise"
                class="exercise-detail-image" (error)="handleImageError($event)">
              </div>
              <div class="exercise-zoom-content-scrollable">
                <!-- Instructions -->
                <div class="exercise-description">
                  <span>Instructions</span>
                  @if (getExerciseInstructions(zoomedExercise.exercise_id); as instructions) {
                    @for (sentence of formatInstructions(instructions); track sentence) {
                      @if (sentence.isTip) {
                        <div class="tip">
                          <i class="fas fa-lightbulb"></i>
                          <div class="tip-text">{{ sentence.text }}</div>
                        </div>
                      } @else {
                        <div class="sentence">{{ sentence.text }}</div>
                      }
                    }
                  }
                </div>
                <!-- Exercise Sets -->
                @if (zoomedExercise && zoomedExercise.sets && zoomedExercise.sets.length) {
                  <div class="sets-container">
                    <div class="sets-header">
                      <span>Sets</span>
                      <span>{{ zoomedExercise.sets.length || 0 }} total</span>
                    </div>
                    <div class="sets-list">
                      @for (set of zoomedExercise.sets; track set; let i = $index) {
                        <div class="set-card">
                          <span class="set-number">Set {{ i + 1 }}</span>
                          <span class="set-info">{{ set.reps }} reps • {{ set.weight }} {{ set.weightUnit }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <!-- Exercise Modal -->
        <app-exercise-modal [isOpen]="isExerciseModalOpen" [selectedTemplate]="selectedTemplate"
          [templateExercises]="templateExercises" (close)="closeExerciseModal()" (save)="saveTemplateExercises($event)">
        </app-exercise-modal>
      </div>

      <!-- Active Workout Session Overlay -->
      @if (activeWorkoutDay) {
        <div class="workout-session-overlay" [class.minimized]="workoutSessionMinimized">
          <div class="workout-session-container">
            <!-- Header with timer and controls -->
            <div class="workout-session-header">
              <div class="workout-session-info">
                <h2>{{ activeWorkoutDay }} Workout</h2>
                <div class="workout-timer">
                  <i class="fas fa-stopwatch"></i>
                  <span class="timer">{{ formatWorkoutTime(workoutElapsedTime) }}</span>
                </div>
              </div>
              <div class="workout-session-controls">
                <button class="btn btn-minimize" (click)="minimizeWorkoutSession()" title="Minimize">
                  <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-finish" (click)="confirmFinishWorkout()">
                  <i class="fas fa-check"></i> Finish
                </button>
              </div>
            </div>
            <!-- Workout Content -->
            <div class="workout-session-content">
              <!-- Exercises List -->
              <div class="workout-session-exercises">
                @for (exercise of getExercisesForDay(activeWorkoutDay); track exercise; let i = $index) {
                  <div
                    class="workout-session-exercise"
                    [class.completed]="exerciseCompletionStatus[exercise.id]">
                    <div class="exercise-session-header">
                      <div class="exercise-session-info">
                        <img [src]="getExerciseThumbnail(exercise.exercise_id)"
                          alt="{{ getExerciseName(exercise.exercise_id) }}"
                          class="exercise-session-img"
                          (error)="handleImageError($event)">
                          <div>
                            <span class="exercise-session-name">{{ getExerciseName(exercise.exercise_id) }}</span>
                            <span class="exercise-session-sets">{{ (exercise.sets?.length ?? 0) }} sets</span>
                          </div>
                        </div>
                        <button class="btn btn-toggle-complete"
                          (click)="toggleExerciseCompletion(exercise.id)">
                          <i class="fas" [class.fa-check-circle]="exerciseCompletionStatus[exercise.id]"
                          [class.fa-circle]="!exerciseCompletionStatus[exercise.id]"></i>
                        </button>
                      </div>
                      <!-- Sets for this exercise -->
                      @if (!exerciseCompletionStatus[exercise.id]) {
                        <div class="exercise-session-sets-list">
                          @for (set of exercise.sets; track set; let j = $index) {
                            <div class="exercise-session-set"
                              [class.completed]="setCompletionStatus[exercise.id + '-' + j]">
                              <span class="set-number">Set {{ j + 1 }}</span>
                              <span class="set-details">{{ set.reps }} reps • {{ set.weight }} {{ set.weightUnit }}</span>
                              <button class="btn btn-complete-set" (click)="toggleSetCompletion(exercise.id, j)">
                                <i class="fas" [class.fa-check-circle]="setCompletionStatus[exercise.id + '-' + j]"
                                [class.fa-circle]="!setCompletionStatus[exercise.id + '-' + j]"></i>
                              </button>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
                <!-- Rest Timer Section -->
                <div class="rest-timer-section">
                  @if (restTimerActive) {
                    <div class="rest-timer-display">
                      <div class="rest-timer-circle">
                        <svg viewBox="0 0 100 100" class="rest-timer-progress">
                          <circle cx="50" cy="50" r="45" class="rest-timer-base" />
                          <circle cx="50" cy="50" r="45" [style.stroke-dashoffset]="getRestTimerProgress()"
                            class="rest-timer-elapsed" />
                          </svg>
                          <div class="rest-timer-text">{{ formatRestTime(restTimeRemaining) }}</div>
                        </div>
                        <button class="btn btn-cancel-rest" (click)="cancelRestTimer()">
                          <i class="fas fa-times"></i> Skip
                        </button>
                      </div>
                    }
                    @if (!restTimerActive) {
                      <div class="rest-timer-buttons">
                        <button class="btn btn-rest" (click)="startRestTimer(30)">
                          <i class="fas fa-stopwatch"></i> 30s
                        </button>
                        <button class="btn btn-rest" (click)="startRestTimer(60)">
                          <i class="fas fa-stopwatch"></i> 1m
                        </button>
                        <button class="btn btn-rest" (click)="startRestTimer(120)">
                          <i class="fas fa-stopwatch"></i> 2m
                        </button>
                        <button class="btn btn-rest" (click)="startRestTimer(180)">
                          <i class="fas fa-stopwatch"></i> 3m
                        </button>
                        <button class="btn btn-rest" (click)="startRestTimer(300)">
                          <i class="fas fa-stopwatch"></i> 5m
                        </button>
                        <button class="btn btn-custom-rest" (click)="promptCustomRestTimer()">
                          <i class="fas fa-clock"></i> Custom
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Minimized Workout Indicator - move outside the overlay so it's always visible when minimized -->
          @if (activeWorkoutDay && workoutSessionMinimized) {
            <div class="minimized-workout-indicator" (click)="maximizeWorkoutSession()">
              <div class="minimized-workout-info">
                <i class="fas fa-dumbbell"></i>
                <span>{{ activeWorkoutDay }} - {{ formatWorkoutTime(workoutElapsedTime) }}</span>
              </div>
              <button class="btn btn-finish-mini" (click)="confirmFinishWorkout(); $event.stopPropagation()" title="Finish Workout">
                <i class="fas fa-check"></i>
              </button>
            </div>
          }

          <!-- Workout Completion Modal -->
          @if (showWorkoutCompletionModal) {
            <div class="workout-completion-modal">
              <div class="workout-completion-container">
                <div class="completion-header">
                  <h2>Workout Complete!</h2>
                  <i class="fas fa-trophy"></i>
                </div>
                <div class="completion-stats">
                  <div class="stat-item">
                    <span class="stat-label">Duration</span>
                    <span class="stat-value">{{ formatWorkoutTime(workoutElapsedTime) }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Exercises</span>
                    <span class="stat-value">{{ getCompletedExercisesCount() }}/{{ getTotalExercisesCount() }}</span>
                  </div>
                </div>
                <div class="completion-actions">
                  <button class="btn btn-primary btn-lg" (click)="finishWorkout()">Done</button>
                </div>
              </div>
            </div>
          }